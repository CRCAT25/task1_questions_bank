const datas = [
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "add1",
        "CompetenceName": "add1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "AC",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 8,
        "Code": 10686,
        "Framework": 10103,
        "Competence": 13,
        "Position": 40,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "add1",
        "CompetenceName": "add1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BD",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 2,
        "Code": 10682,
        "Framework": 10103,
        "Competence": 13,
        "Position": 1,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:52.233",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "add1",
        "CompetenceName": "add1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BOM",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 1,
        "Code": 10690,
        "Framework": 10103,
        "Competence": 13,
        "Position": 53,
        "CompetenceLevel": 3,
        "CompetenceLevelMax": 3,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "test1",
        "CompetenceName": "năng lực 1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "AC",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 8,
        "Code": 10684,
        "Framework": 10103,
        "Competence": 3,
        "Position": 40,
        "CompetenceLevel": 1,
        "CompetenceLevelMax": 3,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "test1",
        "CompetenceName": "năng lực 1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BD",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 2,
        "Code": 10680,
        "Framework": 10103,
        "Competence": 3,
        "Position": 1,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:46.593",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "test1",
        "CompetenceName": "năng lực 1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BOM",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 1,
        "Code": 10688,
        "Framework": 10103,
        "Competence": 3,
        "Position": 53,
        "CompetenceLevel": 1,
        "CompetenceLevelMax": 4,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "Mô tả 1test",
        "CompetenceName": "Mô tả 1test",
        "CategoryName": "Năng lực bổ trợ",
        "DepartmentID": "AC",
        "CategoryID": "BT",
        "Category": 4,
        "Department": 8,
        "Code": 10685,
        "Framework": 10103,
        "Competence": 5,
        "Position": 40,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "Mô tả 1test",
        "CompetenceName": "Mô tả 1test",
        "CategoryName": "Năng lực bổ trợ",
        "DepartmentID": "BD",
        "CategoryID": "BT",
        "Category": 4,
        "Department": 2,
        "Code": 10681,
        "Framework": 10103,
        "Competence": 5,
        "Position": 1,
        "CompetenceLevel": 3,
        "CompetenceLevelMax": 5,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:48.53",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "Mô tả 1test",
        "CompetenceName": "Mô tả 1test",
        "CategoryName": "Năng lực bổ trợ",
        "DepartmentID": "BOM",
        "CategoryID": "BT",
        "Category": 4,
        "Department": 1,
        "Code": 10689,
        "Framework": 10103,
        "Competence": 5,
        "Position": 53,
        "CompetenceLevel": 2,
        "CompetenceLevelMax": 5,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "test3",
        "CompetenceName": "năng lực 3",
        "CategoryName": "Năng lực marketing",
        "DepartmentID": "AC",
        "CategoryID": "MA",
        "Category": 5,
        "Department": 8,
        "Code": 10687,
        "Framework": 10103,
        "Competence": 8,
        "Position": 40,
        "CompetenceLevel": 1,
        "CompetenceLevelMax": 1,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "test3",
        "CompetenceName": "năng lực 3",
        "CategoryName": "Năng lực marketing",
        "DepartmentID": "BD",
        "CategoryID": "MA",
        "Category": 5,
        "Department": 2,
        "Code": 10683,
        "Framework": 10103,
        "Competence": 8,
        "Position": 1,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:55.42",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "test3",
        "CompetenceName": "năng lực 3",
        "CategoryName": "Năng lực marketing",
        "DepartmentID": "BOM",
        "CategoryID": "MA",
        "Category": 5,
        "Department": 1,
        "Code": 10691,
        "Framework": 10103,
        "Competence": 8,
        "Position": 53,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "ABCS",
        "PositionName": "Nhân viên nhà hàng",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "test3",
        "CompetenceName": "năng lực 3",
        "CategoryName": "Năng lực marketing",
        "DepartmentID": "BOM",
        "CategoryID": "MA",
        "Category": 5,
        "Department": 1,
        "Code": 10691,
        "Framework": 10103,
        "Competence": 8,
        "Position": 53,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    }
]

// Khai báo tạo các list Competence và PositionName
const listCompetence = [];
const listPosition = [];

// Lấy danh sách các Competence và sắp xếp chung theo categoryID
const getListCompetence = () => {
    datas.forEach(data => {
        const existingCompetence = listCompetence.find(item => item.id === data.CompetenceID);
        if (!existingCompetence) {
            listCompetence.push({
                categoryID: data.CategoryID,
                categoryName: data.CategoryName,
                id: data.CompetenceID,
                name: data.CompetenceName
            });
        }
    });

    // Sắp xếp danh sách theo categoryID
    listCompetence.sort((a, b) => {
        // So sánh categoryID của 2 phần tử a và b
        if (a.CategoryID < b.CategoryID) {
            return -1;
        }
        if (a.CategoryID > b.CategoryID) {
            return 1;
        }
        return 0;
    });
}

// Lấy danh sách các Position và sắp xếp chung theo departmentID
const getListPosition = () => {
    datas.forEach(data => {
        const existingPosition = listPosition.find(item => item.positionName === data.PositionName);
        if (!existingPosition) {
            listPosition.push({
                departmentID: data.DepartmentID,
                departmentName: data.DepartmentName,
                positionID: data.PositionID,
                positionName: data.PositionName
            });
        }
    });

    // Sắp xếp danh sách theo departmentID
    listPosition.sort((a, b) => {
        // So sánh departmentID của 2 phần tử a và b
        if (a.departmentID < b.departmentID) {
            return -1;
        }
        if (a.departmentID > b.departmentID) {
            return 1;
        }
        return 0;
    });
}

// Tìm object trong datas
const findValue = (pos, com) => {
    return datas.find(data => data.PositionName === pos && data.CompetenceID === com);
}


// render ra các thông số table
const renderFigure = () => {
    const contentTable = document.querySelector('.table-content')
    let htmlFigure = ``
    listCompetence.forEach((comID, i) => {
        htmlFigure += `<div class='content-all-column' style="${i % 2 == 1 && 'background-color: #DBDEE7'}">`
        listPosition.forEach(item => {
            htmlFigure += `
                <div class='competenceName' style='${!!findValue(item.positionName, comID.id) ? 'none' : 'pointer-events: none;'}'>
                    <div class='figure'>
                        <div><input style="${i % 2 == 1 && 'background-color: #DBDEE7; border: 1px solid #DBDEE7'}" id='${item.positionName + '-' + comID.id}-min' onblur="updateData(event, '${item.positionName}', '${comID.id}', 'min')" type='number' min='1' value='${!!findValue(item.positionName, comID.id) ? (!!findValue(item.positionName, comID.id).CompetenceLevel && !!findValue(item.positionName, comID.id).CompetenceLevel ? findValue(item.positionName, comID.id).CompetenceLevel : '') : ''}'/></div>
                        <div><input style="${i % 2 == 1 && 'background-color: #DBDEE7; border: 1px solid #DBDEE7'}" id='${item.positionName + '-' + comID.id}-max' onblur="updateData(event, '${item.positionName}', '${comID.id}', 'max')" type='number' min='1' value='${!!findValue(item.positionName, comID.id) ? (!!findValue(item.positionName, comID.id).CompetenceLevelMax && !!findValue(item.positionName, comID.id).CompetenceLevelMax ? findValue(item.positionName, comID.id).CompetenceLevelMax : '') : ''}'/></div>
                    </div>
                </div>`
        })
        htmlFigure += `</div>`
    });
    contentTable.innerHTML = htmlFigure;
}

// render ra các CompetenceName
const renderCompetenceName = () => {
    let competenceByCategory = {};

    // Phân nhóm Position theo Department
    listCompetence.forEach(competence => {
        if (!competenceByCategory[competence.categoryName]) {
            competenceByCategory[competence.categoryName] = [];
        }
        competenceByCategory[competence.categoryName].push(competence);
    });

    const rowCompetenceName = document.querySelector('.tab-header');
    let htmlListCompetenceID = ``
    Object.entries(competenceByCategory).forEach((item, index) => {
        htmlListCompetenceID += `<div class='item-compe'>
            <div class='compe' style='${index === Object.entries(competenceByCategory).length - 1 ? 'border-right: 1px solid black;' : ''}'>
                <div class='compe-cate'>${item[0]}</div>
                <div class='compe-list-ability'>`
        item[1].forEach(com => {
            htmlListCompetenceID += `
            <div class='competenceName'>
                <div class='figure-title'>${com.id}</div>
                <div style="display: flex;">
                    <span>Min</span>
                    <span>Max</span>
                </div>
            </div>
            `})
        htmlListCompetenceID += `</div></div></div>`
    });
    rowCompetenceName.innerHTML = htmlListCompetenceID;
}

// render ra các PositionName
const renderPositionName = () => {
    let positionByDepartmentID = {};

    // Phân nhóm Position theo Department
    listPosition.forEach(position => {
        if (!positionByDepartmentID[position.departmentID]) {
            positionByDepartmentID[position.departmentID] = [];
        }
        positionByDepartmentID[position.departmentID].push(position);
        console.log(position.departmentName)
    });


    console.log(positionByDepartmentID)

    const columnPositionName = document.querySelector('.position-name-main');
    let htmlListPositionName =
        `<div class='box-list-position'>
            <div class='positionName box-divide-title'>
                <div class="box-diagonal-line"></div>
                <div class='title-nangluc'>Năng lực</div>
                <div class='title-chucdanh'>Chức danh</div>
            </div>
            <div class='list-item-position'>
            `;

    Object.entries(positionByDepartmentID).forEach((item, index) => {
        htmlListPositionName += `
            <div class='item-position' style='${index === Object.entries(positionByDepartmentID).length - 1 ? 'border-bottom: 1px solid black;' : ''}'>
                <div class='department-name' title='${datas.find(data => data.DepartmentID === item[0]).DepartmentName}'>${item[0]}</div>
                <div class='positionName-particular'>
        `
        item[1].forEach(pos => {
            htmlListPositionName += `
                    <div class='positionName'>
                        <div style="display: flex; gap: 5px">
                            <div>${pos.positionID}</div>
                            <div class="line-between-position"></div>
                            <div>${pos.positionName}</div>
                        </div>
                    </div>
            `
        })
        htmlListPositionName += `</div></div>`
    })
    htmlListPositionName += `</div></div></div>`

    htmlListPositionName += `</div> 
    <div class="btn-add-ability btn-add-chucdanh">
    <span>
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
                d="M19.5 10C19.5 15.2467 15.2467 19.5 10 19.5C4.75329 19.5 0.5 15.2467 0.5 10C0.5 4.7533 4.7533 0.5 10 0.5C15.2467 0.5 19.5 4.75329 19.5 10Z"
                stroke="#1A6634" />
            <path d="M10 5.71436V14.2858" stroke="#1A6634" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round" />
            <path d="M5.71436 10.0001H14.2858" stroke="#1A6634" stroke-width="1.5"
                stroke-linecap="round" stroke-linejoin="round" />
        </svg>
    </span>
    <span>Thêm chức danh</span>
</div>
    `
    columnPositionName.innerHTML = htmlListPositionName;
}

// update data Min Max
const updateData = (event, pos, com, level) => {
    let valueMin = document.getElementById(`${pos + '-' + com}-min`);
    let valueMax = document.getElementById(`${pos + '-' + com}-max`);
    const newValue = Number(event.target.value);
    datas.forEach(data => {
        if (data.PositionName === pos && data.CompetenceID === com) {
            if (!(!!data.CompetenceLevel && !!data.CompetenceLevelMax) && newValue > 0) {
                data.CompetenceLevel = newValue;
                data.CompetenceLevelMax = newValue;
                valueMin.value = newValue;
                valueMax.value = newValue;
                showNotify(data.Code, "MIN và MAX");
            }
            if (level === "min" && data.CompetenceLevel !== newValue && typeof (newValue) === typeof (data.CompetenceLevel)) {
                if (newValue > 0 && newValue <= data.CompetenceLevelMax) {
                    data.CompetenceLevel = newValue;
                    showNotify(data.Code, "MIN");
                } else if (newValue > data.CompetenceLevelMax) {
                    event.target.value = data.CompetenceLevelMax;
                    data.CompetenceLevel = Number(event.target.value);
                } else if (newValue <= 0) {
                    event.target.value = findValue(pos, com).CompetenceLevel;
                    data.CompetenceLevel = findValue(pos, com).CompetenceLevel;
                }
            } else if (level === "max" && data.CompetenceLevelMax !== newValue && typeof (newValue) === typeof (data.CompetenceLevel)) {
                data.CompetenceLevelMax = newValue;
                showNotify(data.Code, "MAX");
            }
        }
    });
}

// Thông báo thành công
const showNotify = (text, type) => {
    const notify = document.querySelector(`.box-notify`);
    notify.innerText = `${type} của ID: ${text} được thay đổi`;
    notify.classList.add("show");
    setTimeout(() => {
        notify.classList.remove("show");
    }, 1200);
}

// Thực hiện các hàm bên trong để render ra table
const renderTableData = () => {
    getListCompetence();
    getListPosition();
    renderCompetenceName();
    renderPositionName();
    renderFigure();
}

// Thực hiện render ra table
renderTableData();