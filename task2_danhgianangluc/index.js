const datas = [
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "add1",
        "CompetenceName": "add1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "AC",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 8,
        "Code": 10686,
        "Framework": 10103,
        "Competence": 13,
        "Position": 40,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "add1",
        "CompetenceName": "add1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BD",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 2,
        "Code": 10682,
        "Framework": 10103,
        "Competence": 13,
        "Position": 1,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:52.233",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "add1",
        "CompetenceName": "add1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BOM",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 1,
        "Code": 10690,
        "Framework": 10103,
        "Competence": 13,
        "Position": 53,
        "CompetenceLevel": 3,
        "CompetenceLevelMax": 3,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "test1",
        "CompetenceName": "năng lực 1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "AC",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 8,
        "Code": 10684,
        "Framework": 10103,
        "Competence": 3,
        "Position": 40,
        "CompetenceLevel": 1,
        "CompetenceLevelMax": 3,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "test1",
        "CompetenceName": "năng lực 1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BD",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 2,
        "Code": 10680,
        "Framework": 10103,
        "Competence": 3,
        "Position": 1,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:46.593",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "test1",
        "CompetenceName": "năng lực 1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BOM",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 1,
        "Code": 10688,
        "Framework": 10103,
        "Competence": 3,
        "Position": 53,
        "CompetenceLevel": 1,
        "CompetenceLevelMax": 4,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "Mô tả 1test",
        "CompetenceName": "Mô tả 1test",
        "CategoryName": "Năng lực bổ trợ",
        "DepartmentID": "AC",
        "CategoryID": "BT",
        "Category": 4,
        "Department": 8,
        "Code": 10685,
        "Framework": 10103,
        "Competence": 5,
        "Position": 40,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "Mô tả 1test",
        "CompetenceName": "Mô tả 1test",
        "CategoryName": "Năng lực bổ trợ",
        "DepartmentID": "BD",
        "CategoryID": "BT",
        "Category": 4,
        "Department": 2,
        "Code": 10681,
        "Framework": 10103,
        "Competence": 5,
        "Position": 1,
        "CompetenceLevel": 3,
        "CompetenceLevelMax": 5,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:48.53",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "Mô tả 1test",
        "CompetenceName": "Mô tả 1test",
        "CategoryName": "Năng lực bổ trợ",
        "DepartmentID": "BOM",
        "CategoryID": "BT",
        "Category": 4,
        "Department": 1,
        "Code": 10689,
        "Framework": 10103,
        "Competence": 5,
        "Position": 53,
        "CompetenceLevel": 2,
        "CompetenceLevelMax": 5,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "test3",
        "CompetenceName": "năng lực 3",
        "CategoryName": "Năng lực marketing",
        "DepartmentID": "AC",
        "CategoryID": "MA",
        "Category": 5,
        "Department": 8,
        "Code": 10687,
        "Framework": 10103,
        "Competence": 8,
        "Position": 40,
        "CompetenceLevel": 1,
        "CompetenceLevelMax": 1,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "test3",
        "CompetenceName": "năng lực 3",
        "CategoryName": "Năng lực marketing",
        "DepartmentID": "BD",
        "CategoryID": "MA",
        "Category": 5,
        "Department": 2,
        "Code": 10683,
        "Framework": 10103,
        "Competence": 8,
        "Position": 1,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:55.42",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "test3",
        "CompetenceName": "năng lực 3",
        "CategoryName": "Năng lực marketing",
        "DepartmentID": "BOM",
        "CategoryID": "MA",
        "Category": 5,
        "Department": 1,
        "Code": 10691,
        "Framework": 10103,
        "Competence": 8,
        "Position": 53,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "ABCS",
        "PositionName": "Nhân viên nhà hàng",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "test3",
        "CompetenceName": "năng lực 3",
        "CategoryName": "Năng lực marketing",
        "DepartmentID": "BOM",
        "CategoryID": "MA",
        "Category": 5,
        "Department": 1,
        "Code": 10691,
        "Framework": 10103,
        "Competence": 8,
        "Position": 53,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    }
]

// Khai báo tạo các list Competence và PositionName
const listCompetence = [];
const listPosition = [];

// Lấy danh sách các Competence và sắp xếp chung theo categoryID
const getListCompetence = () => {
    datas.forEach(data => {
        const existingCompetence = listCompetence.find(item => item.id === data.CompetenceID);
        if (!existingCompetence) {
            listCompetence.push({
                categoryID: data.CategoryID,
                categoryName: data.CategoryName,
                id: data.CompetenceID,
                name: data.CompetenceName
            });
        }
    });

    // Sắp xếp danh sách theo categoryID
    listCompetence.sort((a, b) => {
        // So sánh categoryID của 2 phần tử a và b
        if (a.CategoryID < b.CategoryID) {
            return -1;
        }
        if (a.CategoryID > b.CategoryID) {
            return 1;
        }
        return 0;
    });
}

// Lấy danh sách các Position và sắp xếp chung theo departmentID
const getListPosition = () => {
    datas.forEach(data => {
        const existingPosition = listPosition.find(item => item.positionName === data.PositionName);
        if (!existingPosition) {
            listPosition.push({
                departmentID: data.DepartmentID,
                departmentName: data.DepartmentName,
                positionID: data.PositionID,
                positionName: data.PositionName
            });
        }
    });

    // Sắp xếp danh sách theo departmentID
    listPosition.sort((a, b) => {
        // So sánh departmentID của 2 phần tử a và b
        if (a.departmentID < b.departmentID) {
            return -1;
        }
        if (a.departmentID > b.departmentID) {
            return 1;
        }
        return 0;
    });
}

// Tìm object trong datas
const findValue = (pos, com) => {
    return datas.find(data => data.PositionName === pos && data.CompetenceID === com);
}

// render ra các thông số table
const renderFigure = () => {
    const contentTable = document.querySelector('.table-content')
    let htmlFigure = ``
    listCompetence.forEach((comID, i) => {
        htmlFigure += `<div class='content-all-column' style="${i % 2 == 1 && 'background-color: #DBDEE7'}">`
        listPosition.forEach(item => {
            htmlFigure += `
                <div class='competenceName' style='${!!findValue(item.positionName, comID.id) ? 'none' : 'pointer-events: none;'}'>
                    <div class='figure'>
                        <div><input style="${i % 2 == 1 && 'background-color: #DBDEE7; border: 1px solid #DBDEE7'}" id='${item.positionName + '-' + comID.id}-min' onblur="updateData(event, '${item.positionName}', '${comID.id}', 'min')" type='number' min='1' value='${!!findValue(item.positionName, comID.id) ? (!!findValue(item.positionName, comID.id).CompetenceLevel && !!findValue(item.positionName, comID.id).CompetenceLevel ? findValue(item.positionName, comID.id).CompetenceLevel : '') : ''}'/></div>
                        <div><input style="${i % 2 == 1 && 'background-color: #DBDEE7; border: 1px solid #DBDEE7'}" id='${item.positionName + '-' + comID.id}-max' onblur="updateData(event, '${item.positionName}', '${comID.id}', 'max')" type='number' min='1' value='${!!findValue(item.positionName, comID.id) ? (!!findValue(item.positionName, comID.id).CompetenceLevelMax && !!findValue(item.positionName, comID.id).CompetenceLevelMax ? findValue(item.positionName, comID.id).CompetenceLevelMax : '') : ''}'/></div>
                    </div>
                </div>`
        })
        htmlFigure += `</div>`
    });
    contentTable.innerHTML = htmlFigure;
}

// render ra các CompetenceName
const renderCompetenceName = () => {
    let competenceByCategory = {};

    // Phân nhóm Position theo Department
    listCompetence.forEach(competence => {
        if (!competenceByCategory[competence.categoryName]) {
            competenceByCategory[competence.categoryName] = [];
        }
        competenceByCategory[competence.categoryName].push(competence);
    });

    const rowCompetenceName = document.querySelector('.tab-header');
    let htmlListCompetenceID = ``
    Object.entries(competenceByCategory).forEach((item, index) => {
        htmlListCompetenceID += `<div class='item-compe'>
            <div class='compe' style='${index === Object.entries(competenceByCategory).length - 1 ? 'border-right: 1px solid rgba(26, 102, 52);' : ''}'>
                <div class='compe-cate' title='${item[0]}'>${item[0]}</div>
                <div class='compe-list-ability'>`
        item[1].forEach(com => {
            htmlListCompetenceID += `
            <div class='competenceName'>
                <div class='figure-title'>${com.id}</div>
                <div style="display: flex;">
                    <span>Min</span>
                    <span>Max</span>
                </div>
                <div class='icon-i'>
                    <svg width="12" height="12" viewBox="0 0 6 6" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 0C2.40666 0 1.82664 0.175947 1.33329 0.505591C0.839943 0.835235 0.455426 1.30377 0.228363 1.85195C0.00129984 2.40013 -0.0581101 3.00333 0.0576455 3.58527C0.173401 4.16721 0.459123 4.70176 0.878681 5.12132C1.29824 5.54088 1.83279 5.8266 2.41473 5.94235C2.99667 6.05811 3.59987 5.9987 4.14805 5.77164C4.69623 5.54457 5.16476 5.16006 5.49441 4.66671C5.82405 4.17336 6 3.59334 6 3C5.99921 2.20459 5.68288 1.44199 5.12044 0.879557C4.55801 0.31712 3.79541 0.000794215 3 0V0ZM3 5.45456C2.51453 5.45456 2.03997 5.3106 1.63632 5.04089C1.23267 4.77118 0.918061 4.38783 0.732281 3.93932C0.546501 3.49081 0.497893 2.99728 0.592602 2.52114C0.687312 2.045 0.921087 1.60764 1.26436 1.26436C1.60764 0.921085 2.045 0.687311 2.52114 0.592601C2.99728 0.497891 3.49081 0.5465 3.93932 0.73228C4.38783 0.91806 4.77118 1.23267 5.04089 1.63632C5.31061 2.03997 5.45456 2.51453 5.45456 3C5.45412 3.65085 5.19537 4.27492 4.73514 4.73514C4.27492 5.19537 3.65085 5.45411 3 5.45456Z" fill="#31ADFF"/>
                        <path d="M3.0001 1.26392C2.92456 1.26392 2.85072 1.28632 2.78791 1.32828C2.7251 1.37025 2.67615 1.4299 2.64724 1.49969C2.61833 1.56948 2.61077 1.64628 2.6255 1.72037C2.64024 1.79445 2.67662 1.86251 2.73003 1.91592C2.78345 1.96934 2.8515 2.00571 2.92559 2.02045C2.99968 2.03519 3.07647 2.02763 3.14626 1.99872C3.21605 1.96981 3.2757 1.92086 3.31767 1.85805C3.35964 1.79524 3.38204 1.72139 3.38204 1.64585C3.38174 1.54465 3.34141 1.44767 3.26985 1.37611C3.19828 1.30455 3.10131 1.26421 3.0001 1.26392Z" fill="#31ADFF"/>
                        <path d="M2.99988 2.47253C2.92396 2.47273 2.8512 2.50298 2.79751 2.55667C2.74383 2.61035 2.71358 2.68311 2.71338 2.75903V4.47747C2.71338 4.55343 2.74355 4.62628 2.79727 4.67999C2.85098 4.7337 2.92382 4.76388 2.99978 4.76388C3.07574 4.76388 3.14859 4.7337 3.2023 4.67999C3.25602 4.62628 3.28619 4.55343 3.28619 4.47747V2.75903C3.28599 2.68314 3.25577 2.61041 3.20212 2.55673C3.14848 2.50305 3.07577 2.47278 2.99988 2.47253Z" fill="#31ADFF"/>
                    </svg>
                </div>
                

            </div>
            `})
        htmlListCompetenceID += `</div></div></div>`
    });
    rowCompetenceName.innerHTML = htmlListCompetenceID;
}

// render ra các PositionName
const renderPositionName = () => {
    let positionByDepartmentID = {};

    // Phân nhóm Position theo Department
    listPosition.forEach(position => {
        if (!positionByDepartmentID[position.departmentID]) {
            positionByDepartmentID[position.departmentID] = [];
        }
        positionByDepartmentID[position.departmentID].push(position);
        console.log(position.departmentName)
    });

    const columnPositionName = document.querySelector('.position-name-main');
    let htmlListPositionName =
        `<div class='box-list-position'>
            <div class='positionName box-divide-title'>
                <div class="box-diagonal-line"></div>
                <div class='title-nangluc'>Năng lực</div>
                <div class='title-chucdanh'>Chức danh</div>
            </div>
            <div class='list-item-position'>
            `;

    Object.entries(positionByDepartmentID).forEach((item, index) => {
        htmlListPositionName += `
            <div class='item-position' style='${index === Object.entries(positionByDepartmentID).length - 1 ? 'border-bottom: 1px solid rgba(26, 102, 52);' : ''}'>
                <div class='department-name' title='${datas.find(data => data.DepartmentID === item[0]).DepartmentName}'>${item[0]}</div>
                <div class='positionName-particular'>
        `
        item[1].forEach(pos => {
            htmlListPositionName += `
                    <div class='positionName' style='border-left: 1px solid rgba(26, 102, 52);'>
                        <div style="display: flex; gap: 5px">
                            <div title='${pos.positionID}'>${pos.positionID}</div>
                            <div class="line-between-position"></div>
                            <div>${pos.positionName}</div>
                        </div>
                    </div>
            `
        })
        htmlListPositionName += `</div></div>`
    })
    htmlListPositionName += `</div></div></div>`

    htmlListPositionName += `</div> 
    <div class="btn-add-ability btn-add-chucdanh">
    <span>
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
                d="M19.5 10C19.5 15.2467 15.2467 19.5 10 19.5C4.75329 19.5 0.5 15.2467 0.5 10C0.5 4.7533 4.7533 0.5 10 0.5C15.2467 0.5 19.5 4.75329 19.5 10Z"
                stroke="#1A6634" />
            <path d="M10 5.71436V14.2858" stroke="#1A6634" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round" />
            <path d="M5.71436 10.0001H14.2858" stroke="#1A6634" stroke-width="1.5"
                stroke-linecap="round" stroke-linejoin="round" />
        </svg>
    </span>
    <span>Thêm chức danh</span>
</div>
    `
    columnPositionName.innerHTML = htmlListPositionName;
}

// update data Min Max
const updateData = (event, pos, com, level) => {
    let valueMin = document.getElementById(`${pos + '-' + com}-min`);
    let valueMax = document.getElementById(`${pos + '-' + com}-max`);
    const newValue = Number(event.target.value);
    datas.forEach(data => {
        if (data.PositionName === pos && data.CompetenceID === com) {
            if (!(!!data.CompetenceLevel && !!data.CompetenceLevelMax) && newValue > 0) {
                if(newValue < 5){
                    data.CompetenceLevel = newValue;
                    data.CompetenceLevelMax = newValue;
                    valueMin.value = newValue;
                    valueMax.value = newValue;
                    showNotify(data.Code, "MIN và MAX");
                }
                else{
                    data.CompetenceLevel = 5;
                    data.CompetenceLevelMax = 5;
                    valueMin.value = 5;
                    valueMax.value = 5;
                    showNotify(data.Code, "MIN và MAX");
                }
            }
            if (level === "min" && data.CompetenceLevel !== newValue && typeof (newValue) === typeof (data.CompetenceLevel)) {
                if (newValue <= 0 || newValue > 5) {
                    event.target.value = findValue(pos, com).CompetenceLevel;
                    data.CompetenceLevel = findValue(pos, com).CompetenceLevel;
                }
                else{
                    if (newValue > 0 && newValue <= data.CompetenceLevelMax) {
                        data.CompetenceLevel = newValue;
                        showNotify(data.Code, "MIN");
                    } else if (newValue > data.CompetenceLevelMax) {
                        event.target.value = data.CompetenceLevelMax;
                        data.CompetenceLevel = Number(event.target.value);
                    }
                }
                
            } else if (level === "max" && data.CompetenceLevelMax !== newValue && typeof (newValue) === typeof (data.CompetenceLevel)) {
                if (newValue < data.CompetenceLevel || newValue < 0 || newValue > 5){
                    event.target.value = data.CompetenceLevelMax;
                    data.CompetenceLevelMax = Number(event.target.value);
                }
                else{
                    data.CompetenceLevelMax = newValue;
                    showNotify(data.Code, "MAX");
                }
            }
        }
    });
}

// Thông báo thành công
const showNotify = (text, type) => {
    const notify = document.querySelector(`.box-notify`);
    notify.innerText = `${type} của ID: ${text} được thay đổi`;
    notify.classList.add("show");
    setTimeout(() => {
        notify.classList.remove("show");
    }, 1200);
}

// Thực hiện các hàm bên trong để render ra table
const renderTableData = () => {
    getListCompetence();
    getListPosition();
    renderCompetenceName();
    renderPositionName();
    renderFigure();
}

// Thực hiện render ra table
renderTableData();